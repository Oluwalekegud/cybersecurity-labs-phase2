# Lab - Packet Crafting with Scapy

## Objectives
In this lab, you will use Scapy, a Python-based packet manipulation tool, to craft custom packets. These custom packets will be used to perform reconnaissance on a target system.

### Parts
- **Part 1**: Investigate the Scapy Tool.
- **Part 2**: Use Scapy to Sniff Network Traffic.
- **Part 3**: Create and Send an ICMP Packet.
- **Part 4**: Create and Send TCP SYN Packets.

## Background / Scenario
Penetration testers and ethical hackers often use specially-crafted packets to discover and/or exploit vulnerabilities in clients’ infrastructure and systems. You have used Nmap to scan and analyze vulnerabilities in a computer attached to the local network.

In this lab, you will perform further reconnaissance on the same computer using custom ICMP and TCP packets.

## Required Resources
- Kali VM customized for Ethical Hacker course
- Internet Access

## Instructions

### Part 1: Investigate the Scapy Tool
Scapy is a multi-purpose tool originally written by Philippe Biondi. In this part, you will load the Scapy tool and explore some of its capabilities. Tools like Scapy should only be used to scan or communicate with machines that you own or have written permission to access.

#### Step 1: Investigate Scapy documentation and resources.
Scapy can be run interactively from the Python shell or can be incorporated into Python programs by importing the python-scapy module. The Scapy tool has extensive documentation online at [Scapy Documentation](https://scapy.readthedocs.io/en/latest/introduction.html). This customized Kali Linux is distributed with both Python and Scapy pre-installed.

1. Start the Kali VM and login.
2. Open the Firefox browser and navigate to [Scapy Documentation](https://scapy.readthedocs.io/en/latest/introduction.html). Read the Introduction page written by the Scapy creator, Philippe Biondi.

   **How does the author describe the capabilities of Scapy in the first paragraph of the page?**
   - [Your Answer Here]

#### Step 2: Use Scapy interactive command mode.
Enter the `scapy` command in a terminal window to load the Python interpreter. By using this command, the interpreter runs pre-loaded with the Scapy classes and objects. You will enter Scapy commands interactively and receive the output. Scapy commands can also be embedded in a Python script.

The commands to craft and send packets require root privileges to run. Use the `sudo su` command to obtain root privileges before starting Scapy. If prompted for a password, enter `kali`.

```bash
┌──(kali㉿kali)-[~]
└─$ sudo su
[sudo] password for kali:
┌──(root㉿kali)-[/home/kali]
└─#
```
Load the Scapy tool using the scapy command. The interactive Python interpreter will load and present a screen image similar to that shown:

```bash
┌──(kali㉿kali)-[~]
└─$ scapy

```

To determine how many types of TFTP packet formats are listed in the Scapy shell, follow these steps:

Open Scapy: Launch the Scapy shell in your terminal.
Execute Command: At the >>> prompt, type ls() and press Enter.
Scroll Through Output: Look for the section labeled "TFTP" in the output. This section will detail the various packet formats associated with TFTP.
Count Formats: Count the number of distinct TFTP packet formats displayed.

# Step 3: Examine the Fields in an IPv4 Packet Header

Understanding the structure of an IP packet is crucial for creating and sending custom packets over the network. Each IP packet includes a header that provides important information about the packet's structure. Familiarizing yourself with this information is essential before proceeding with the lab.

## IPv4 Packet Header Fields

The binary values of each field in the IPv4 header define various settings for the IP packet. The protocol header diagrams, which are read from left to right and top to bottom, serve as a visual reference when discussing these fields. Below are the significant fields found in an IPv4 header:

- **Version**: This 4-bit field is set to `0100`, identifying the packet as an IPv4 packet.

- **Differentiated Services (DS)**: Previously known as the Type of Service (ToS) field, this 8-bit field determines the priority of the packet. The six most significant bits represent the Differentiated Services Code Point (DSCP), while the last two bits are for Explicit Congestion Notification (ECN).

- **Time to Live (TTL)**: An 8-bit value that limits the packet's lifetime. The source device sets the initial TTL, which decreases by one with each router that processes the packet. If TTL reaches zero, the router discards the packet and sends an ICMP Time Exceeded message back to the source IP address. The router must also recalculate the Header Checksum whenever TTL is decremented.

- **Protocol**: This 8-bit field identifies the next-level protocol, indicating the type of data payload the packet carries. Common values include ICMP (1), TCP (6), and UDP (17).

- **Header Checksum**: Used to detect corruption in the IPv4 header.

- **Source IPv4 Address**: A 32-bit binary value that represents the source IPv4 address of the packet, which is always a unicast address.

- **Destination IPv4 Address**: A 32-bit binary value that represents the destination IPv4 address of the packet. This address can be unicast, multicast, or broadcast.

To list the details of the fields and options available in each protocol header, you can use the `ls()` function in Scapy. The syntax to use a function in Scapy is:

```python
>>> ls(IP)

# Compare IP Fields in Scapy with the Packet Header

Compare the fields in the IP detail on Scapy with the packet header described in Step 3a. Are there any differences between the two?

## Answer Area
<!----><!---->

Which field do you think you would change to create a packet that would generate a reply to a target machine, rather than the machine that actually sent the packet?

## Answer Area

# Part 2: Use Scapy to Sniff Network Traffic

Scapy can be used to capture and display network traffic, similar to `tcpdump` or `tshark`.

## Step 1: Use the `sniff()` function

Use the `sniff()` function to collect traffic using the default `eth0` interface of your VM. Start the capture with the `sniff()` function without specifying any arguments.

```python
>>> sniff()
```
Open a second terminal window and ping an internet address, such as www.cisco.com. Remember to specify the count using the -c argument.

ping -c 5 www.cisco.com

Return to the terminal window that is running the Scapy tool. Press CTRL-C to stop the capture. You should receive output similar to the following:


C<Sniffed: TCP:75 UDP:42 ICMP:32 Other:2>

Step 2: View the captured traffic using the summary() function
To view the captured traffic, assign the output of the sniff() function to a variable by using the underscore (_) as a placeholder. The underscore in Python is used to temporarily hold the output of the last executed function. Assign this to the variable a, and then run the summary() function to view a brief summary of the packets captured.


>>> a=_
>>> a.summary()
The output of this command may be extensive, depending on the applications running on the network. Scapy will display a brief summary of each captured packet.

### Step 2:  Capture and save traffic on a specific interface.

In this step, you will capture traffic to and from a device connected to a virtual network in your Kali Linux VM.

1.  Open a new terminal window. Use the **ifconfig** command to determine the name of the interface that is assigned the IP address **10.6.6.1**. This is the default gateway address for one of the virtual networks running inside Kali. Note the name of interface.
2.  Return to the terminal window that is running the Scapy tool. Use the syntax **sniff(iface="**_interface name_**")** to begin the capture on the **br-internal** virtual interface.

\>>> **sniff(iface="br-internal")**

3.  Open Firefox and navigate to the URL **http://10.6.6.23/**. When the Gravemind home page opens, return to the terminal window that is running the Scapy tool. Press **CTRL-C**. You should receive output similar to:

^C

4.  View the captured traffic as you did in Step 1d.

\>>> **a=\_**

\>>> **a.summary()**

### Step 3: Examine the collected packets.

### 

In this step, you will filter the collected traffic to include only ICMP traffic, limit the number of packets being collected, and view the individual packet details.

1.  Use interface ID associated with 10.6.6.1 (br-internal) to capture ten ICMP packets sent and received on the internal virtual network. The syntax is **sniff(iface="**_interface name_**", filter = “**_protocol_**", count =** _integer_**)**.

\>>> **sniff(iface="br-internal",filter = “icmp",count = 10)**

2.  Open a second terminal window and ping the host at 10.6.6.23.

┌──(kali㉿Kali)-\[~\]

└─$ **ping –c 10 10.6.6.23**

3.  Return to the terminal window running the Scapy tool. The capture automatically stopped when 10 packets were sent or received. View the captured traffic with line numbers using the **nsummary()** function.

\>>>  **a=\_** 

\>>> **a.nsummary()**

The summary should only contain 10 lines because the capture count is equal to 10.

Part 3: Create and Send an ICMP Packet.
---------------------------------------

### 

ICMP is a protocol designed to send control messages between network devices for various purposes. There are many types of ICMP packets, with echo-request and echo-reply the most familiar to IT technicians. To see a list of the message types that can be sent and received using ICMP, navigate to [https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml](https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml)**.**

### Step 1: Use interactive mode to create and send a custom ICMP packet.

### 

1.  In a Scapy terminal window, enter the command to sniff traffic from the interface connected to the 10.6.6.0/24 network.

\>>> **sniff(iface="br-internal")**

2.  Open another terminal window, enter **sudo su** to perform packet crafting as root. Start a second instance of Scapy. Enter the **send**() function to send a packet to 10.6.6.23 with a modified ICMP payload.

┌──(kali㉿kali)-\[~\]

└─$ **sudo su**

\[sudo\] password for kali:

┌──(root㉿kali)-\[/home/kali\]

└─# **scapy**

\>>> **send(IP(dst="10.6.6.23")/ICMP()/"This is a test")**

Response

Sent 1 packet

3.  Return to the first terminal window and press **CTRL-C**. You should receive a response similar to this:

^C

4.  Enter the summary command to display the summary with packet numbers.

\>>> **a=\_**

\>>> **a.nsummary()**

### Step 2: View and compare the ICMP packet contents.

### 

Use the packet numbers to view the individual ICMP Echo-request and Echo-reply packets. Compare those packets to the ones that you examined in Part 2, Step 3d.

\>>> **a\[_packet number_\]**

Part 4: Create and Send a TCP SYN Packet.
-----------------------------------------

### 

In this part, you will use Scapy to determine if port 445, a Microsoft Windows drive share port, is open on the target system at 10.6.6.23.

### Step 1: Start the packet capture on the internal interface.

### 

1.  In the original Scapy terminal window, begin a packet capture on the internal interface attached to the 10.6.6.0/24 network. Use the interface name that you obtained previously.
2.  Navigate to the second terminal window. Create and send a TCP SYN packet using the command shown.

\>>> **send(IP(dst="10.6.6.23")/TCP(dport=445, flags="S"))**

1 packet sent

This command sent an IP packet to the host with IP address 10.6.6.23. The packet is addressed to TCP port 445 and has the S (SYN) flag set.

3.  Close the terminal window.

### Step 2: Review the captured packets.

### 

1.  In the original Scapy terminal window, stop the packet capture by pressing **CTRL-C**. The output should be similar to that shown.

^C

2.  View the captured TCP packets using the **nsummary()** function. Display the detail of the TCP packet that was returned from the target computer at 10.6.6.23.

\>>> **a\[_packet number_\]**

Reflection Questions
====================
